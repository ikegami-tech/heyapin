<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>部屋ピン</title>
<link rel="icon" href="favicon.ico">
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="loading">
  <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px;">読み込み中...</div>
  <div id="progress-wrapper" style="display:none; width: 240px; text-align: center;">
    <div style="width: 100%; height: 10px; background: rgba(255,255,255,0.3); border-radius: 5px; overflow: hidden; margin-bottom: 5px;">
      <div id="progress-bar" style="width: 0%; height: 100%; background: #4caf50; transition: width 0.3s ease;"></div>
    </div>
    <div id="progress-text" style="color: white; font-size: 0.9rem;">0 / 0 件完了</div>
  </div>
</div>

<div id="login-screen">
  <div class="login-box">
    <h2>ログイン</h2>
    <input type="text" id="loginId" placeholder="ユーザーID">
    <input type="password" id="loginPass" placeholder="パスワード">
    <button type="button" class="btn-primary" onclick="tryLogin()">ログイン</button>
  </div>
</div>

<div id="app-screen">
  <header>
    <div class="header-left-group">
      <div id="header-title" onclick="switchTab('map-view')">部屋予約</div>
      <button type="button" class="btn-header-refresh" onclick="manualRefresh()">
        <span>&#8635;</span> 更新
      </button>
      <span id="last-update-time" class="last-update-text"></span>
    </div>
    <div class="user-info">
      <button id="btn-header-back" class="btn-secondary btn-sm" onclick="switchTab('map-view')" style="display: none; margin-right: 10px;">↩ 戻る</button>
      <div class="settings-container">
        <span class="settings-icon" onclick="toggleSettingsMenu()">&#9881;</span>
        <div id="settings-dropdown" class="settings-dropdown-content">
          <div class="settings-user-display">👤 <span id="display-user-name"></span> さん</div>
          <div class="settings-item" onclick="openPasswordModal()"><span>&#128274;</span> PW変更</div>
          <div class="settings-item" onclick="openHistoryFromMenu()"><span>📅</span> 履歴</div>
          <div class="settings-item" onclick="openContactModal()"><span>&#9993;</span> お問い合わせ</div>
          <div class="settings-item logout-item" onclick="logout()"><span>&#10162;</span> ログアウト</div>
        </div>
      </div>
    </div>
  </header>

  <div id="view-map-view" class="view-container active">
    <div class="map-wrapper">
      <div class="floor-selector">
          <button class="floor-tab active" onclick="switchFloor(7)" id="tab-7f">7階</button>
          <button class="floor-tab" onclick="switchFloor(6)" id="tab-6f">6階</button>
      </div>
      <div id="dual-map-container">
        <div id="area-7f" class="floor-map-unit active">
            <div class="map-inner-wrapper">
                <img id="map-img-7" class="map-image" src="" alt="7階マップ">
                <div id="overlay-container-7" class="overlay-layer"></div>
            </div>
        </div>
        <div id="area-6f" class="floor-map-unit">
            <div class="map-inner-wrapper">
                <img id="map-img-6" class="map-image" src="" alt="6階マップ">
                <div id="overlay-container-6" class="overlay-layer"></div>
            </div>
        </div>
      </div>
      
      <div id="map-timeline-section">
        <h4 id="map-selected-room-name" style="text-align:center; margin:5px 0;"></h4>
        <div class="date-controller">
          <button onclick="changeDate(-1, 'map-date')">&lt;</button>
          <div>
             <input type="date" id="map-date" onchange="renderVerticalTimeline('map'); updateDayDisplay('map-date');">
             <span id="map-date-week" style="font-weight:bold; margin-left:5px;"></span>
          </div>
          <button onclick="changeDate(1, 'map-date')">&gt;</button>
        </div>
        
        <div class="calendar-scroll-area">
            <div class="time-axis-col" id="time-axis-map">
                <div class="time-axis-header"></div>
                </div>
            <div class="rooms-container" id="rooms-container-map">
                </div>
        </div>
      </div>
    </div>
    
    <button class="fab-avail-btn" onclick="openAvailabilityModal()">
      <span>空室</span><span>確認</span>
    </button>
  </div>
  
  <div id="view-logs" class="view-container">
    <div class="log-wrapper">
      <div class="log-header-area">
          <h3>操作履歴</h3>
          <input type="text" id="log-search-input" placeholder="検索..." oninput="searchLogs()">
      </div>
      <table class="log-table">
        <thead><tr><th>日時</th><th>操作者</th><th>操作</th><th>詳細</th></tr></thead>
        <tbody id="log-tbody"></tbody>
      </table>
      <div id="log-pagination" class="pagination-container"></div>
    </div>
  </div>
</div>

<div id="detailModal" class="modal">
  <div class="modal-content modal-sm">
    <div class="modal-top-bar">
      <h3>予約詳細</h3>
      <span class="close-icon" onclick="closeDetailModal()">&times;</span>
    </div>
    <div id="detail-meta-info" class="detail-meta-info"></div>
    <table class="detail-table">
      <tr><th>日時</th><td id="detail-time" class="text-bold"></td></tr>
      <tr><th>部屋</th><td id="detail-room"></td></tr>
      <tr><th>用件</th><td id="detail-title"></td></tr>
      <tr><th>参加者</th><td id="detail-members"></td></tr>
      <tr><th>備考</th><td><div id="detail-note" class="note-scroll-area"></div></td></tr>
    </table>
    <div class="modal-footer">
      <button class="btn-secondary btn-equal" onclick="closeDetailModal()">閉じる</button>
      <button id="btn-go-edit" class="btn-primary btn-equal">編集する</button>
    </div>
  </div>
</div>

<div id="bookingModal" class="modal">
  <div class="modal-content">
    <div class="modal-top-bar">
        <h3 id="modal-title">新規予約</h3>
        <span onclick="closeModal()" class="close-icon">&times;</span>
    </div>
    <input type="hidden" id="edit-res-id">
    
    <label>部屋</label>
    <select id="input-room"></select>

    <div class="form-row align-end mb-15" style="display:flex; gap:10px; margin-top:10px;">
      <div class="flex-1-2"><label>日付</label><input type="date" id="input-date"></div>
      <div class="flex-1">
        <label>開始</label>
        <div class="time-picker-wrapper">
          <input type="tel" id="input-start" placeholder="09:00" onblur="formatTimeInput(this)">
          <div class="time-picker-arrow" onclick="this.previousElementSibling.click()">▼</div>
        </div>
      </div>
      <div style="padding-bottom:10px;">～</div>
      <div class="flex-1">
        <label>終了</label>
        <div class="time-picker-wrapper">
          <input type="tel" id="input-end" placeholder="10:00" onblur="formatTimeInput(this)">
          <div class="time-picker-arrow" onclick="this.previousElementSibling.click()">▼</div>
        </div>
      </div>
    </div>

    <label>用件</label>
    <input type="text" id="input-title" placeholder="会議名など">

    <div id="edit-series-option" style="display:none; background:#e8f5e9; padding:10px; margin:10px 0; border-radius:4px; border:1px solid #c8e6c9;">
        <label style="color:#2e7d32; display:flex; align-items:center; gap:5px;">
            <input type="checkbox" id="check-sync-series" checked>
            この繰り返しの予定も一緒に変更する
        </label>
        <div style="font-size:0.8rem; color:#666; margin-top:5px; margin-left:20px;">※チェックを外すと単発変更になり、繰り返しから外れます。</div>
    </div>

    <div id="create-repeat-section" style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
       <label style="display:flex; align-items:center; gap:5px;">
            <input type="checkbox" id="check-repeat" onchange="toggleRepeatOptions()">
            繰り返し予約をする
       </label>
       <div id="repeat-options" style="display:none; background:#f8f9fa; padding:10px; margin-top:5px; border-radius:4px;">
           <div style="display:flex; gap:5px; align-items:center; margin-bottom:10px;">
               <span>間隔:</span>
               <input type="number" id="repeat-interval" value="1" min="1" style="width:50px; text-align:center;">
               <select id="repeat-unit" style="width:auto;"><option value="week" selected>週</option><option value="month">月</option><option value="day">日</option></select>
               <span>おき</span>
           </div>
           <div style="border-top:1px dashed #ccc; padding-top:5px;">
               <div>終了条件:</div>
               <label><input type="radio" name="repeat-end" value="none" checked> 指定なし(最大3ヶ月)</label><br>
               <label><input type="radio" name="repeat-end" value="date"> 指定日まで <input type="date" id="repeat-until" style="width:120px;"></label><br>
               <label><input type="radio" name="repeat-end" value="count"> 回数 <input type="number" id="repeat-count" value="10" style="width:50px;"> 回</label>
           </div>
       </div>
    </div>

    <label>参加者</label>
    <div id="group-buttons-area" style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:5px;"></div>
    <div class="shuttle-container">
        <div class="shuttle-box">
            <div class="shuttle-header">候補</div>
            <input type="text" id="shuttle-search-input" placeholder="検索..." oninput="renderShuttleLists(this.value)" style="width:100%; box-sizing:border-box;">
            <div class="shuttle-list" id="list-candidates"></div>
        </div>
        <div class="shuttle-box bg-selected">
            <div class="shuttle-header">選択済み</div>
            <div class="shuttle-list" id="list-selected"></div>
        </div>
    </div>

    <label>備考</label>
    <textarea id="input-note" rows="3"></textarea>

    <div class="modal-footer">
      <button type="button" id="btn-back-avail" class="btn-secondary" onclick="backToAvailability()" style="display:none; margin-right:auto;">←戻る</button>
      <button type="button" class="btn-secondary" onclick="closeModal()">キャンセル</button>
      <button type="button" class="btn-primary" onclick="saveBooking()">保存</button>
      <button type="button" id="btn-delete" class="btn-danger" onclick="deleteBooking()" style="display:none;">削除</button>
    </div>
  </div>
</div>

<div id="groupCreateModal" class="modal">
  <div class="modal-content modal-md">
    <h3>グループ作成</h3>
    <input type="hidden" id="edit-group-id">
    <label>グループ名</label><input type="text" id="new-group-name">
    <label>メンバー</label>
    <div class="shuttle-container">
        <div class="shuttle-box"><input type="text" id="group-shuttle-search" placeholder="検索" oninput="renderGroupCreateShuttle()"><div class="shuttle-list" id="group-create-candidates"></div></div>
        <div class="shuttle-box bg-selected"><div class="shuttle-header">選択中</div><div class="shuttle-list" id="group-create-selected"></div></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeGroupModal()">キャンセル</button>
      <button class="btn-primary" onclick="saveNewGroup()">保存</button>
    </div>
  </div>
</div>

<div id="availabilityModal" class="modal">
  <div class="modal-content">
    <div class="modal-top-bar"><h3>空き状況確認</h3><span onclick="closeAvailabilityModal()" class="close-icon">&times;</span></div>
    <div class="avail-search-row">
        <div class="avail-input-group"><label>日付</label><input type="date" id="avail-date"></div>
        <div class="avail-time-row">
            <div class="avail-input-group"><label>開始</label><input type="tel" id="avail-start"></div>
            <div style="padding-top:30px;">～</div>
            <div class="avail-input-group"><label>終了</label><input type="tel" id="avail-end"></div>
        </div>
        <button class="btn-primary btn-search-avail" onclick="execAvailabilitySearch()">検索</button>
    </div>
    <div id="avail-result-container" style="flex:1; overflow-y:auto;"></div>
    <div class="modal-footer"><button class="btn-secondary" onclick="closeAvailabilityModal()">閉じる</button></div>
  </div>
</div>

<div id="passwordModal" class="modal">
  <div class="modal-content modal-sm">
    <h3>パスワード変更</h3>
    <label>現在のパスワード</label><input type="password" id="old-pass">
    <label>新しいパスワード</label><input type="password" id="new-pass">
    <label>確認</label><input type="password" id="new-pass-confirm">
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closePasswordModal()">キャンセル</button>
      <button class="btn-primary" onclick="savePassword()">変更</button>
    </div>
  </div>
</div>

<div id="contactModal" class="modal">
  <div class="modal-content modal-sm">
    <h3>お問い合わせ</h3>
    <label>内容</label><textarea id="contact-message" rows="5"></textarea>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeContactModal()">キャンセル</button>
      <button class="btn-primary" onclick="sendContactFeedback()">送信</button>
    </div>
  </div>
</div>

<script src="script.js"></script>
</body>
</html>
